<html>
  <head>
    <title>Debug Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="http://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>

    <script src="js/Syncronizer.js"></script>
  </head>
  <body>
    <div></div>
    <br />
    <button id="load">Load Video</button>
    <div id="container" style="position:relative;height:50vh;width: 50vw;">
      <div style="position: absolute;top:0;left:0;z-index:2147483647">
        <img id="qrcode" src="img/qrcode.png" height="200px" width="200px" />
        <div style="position:relative;width:200px;top:-20px">
          <div style="background:white;font-size: 1rem; text-align: center">
            scan to play audio on your phone
          </div>
        </div>
      </div>
      <video id="video" style="width:100%;height:100%"></video>
      <button
        id="toggle-fullscreen"
        style="position:absolute;bottom:50px;right:50px"
      >
        fullscreen
      </button>
    </div>

    <script>
      loadPlayer();
      var syncedPlayer;
      async function loadPlayer() {
        syncedPlayer = new SyncedPlayer();
        await syncedPlayer.init();
        if (SyncedPlayer.isSupported()) {
          var video = document.getElementById("video");
          syncedPlayer.attachMedia(video);
          syncedPlayer.on(SyncedPlayer.Events.MANIFEST_PARSED, function() {
            console.log("start");
            toggleFullscreen();
            hideLoad();
          });
          syncedPlayer.on(
            SyncedPlayer.Events.FRAG_PARSING_INIT_SEGMENT,
            (event, data) => {
              console.log(
                data.frag.relurl,
                new Date(data.frag.programDateTime).toISOString()
              );
              console.log(syncedPlayer.serverTime - data.frag.programDateTime);

              setTimeout(() => {
                syncedPlayer.media.play();
              }, 23000 - (syncedPlayer.serverTime - data.frag.programDateTime));
            }
          );

          document.querySelector("#load").addEventListener("click", function() {
            syncedPlayer.loadSource("/streams/video.m3u8");
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.addEventListener("canplay", function() {
            video.play();
          });
          document.querySelector("#load").addEventListener("click", function() {
            video.src = "/streams/video.m3u8";
          });
        }
      }

      document
        .getElementById("toggle-fullscreen")
        .addEventListener("click", toggleFullscreen);
      function toggleFullscreen() {
        // if already full screen; exit
        // else go fullscreen
        if (
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.mozFullScreenElement ||
          document.msFullscreenElement
        ) {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        } else {
          element = document.getElementById("container");
          if (element.requestFullscreen) {
            element.requestFullscreen();
          } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
          } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        }
      }

      function hideLoad() {
        document.getElementById("load").hidden = true;
      }
    </script>
  </body>
</html>
